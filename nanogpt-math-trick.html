<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Christof’s AI-related notes - NanoGPT - Math Trick</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Christof’s AI-related notes - NanoGPT - Math Trick">
<meta property="og:description" content="Note how the mean of -0.9, 1.3, -0.7, -1.6, -1.4 is -0.7">
<meta property="og:site-name" content="Christof's AI-related notes">
<meta name="twitter:title" content="Christof’s AI-related notes - NanoGPT - Math Trick">
<meta name="twitter:description" content="Note how the mean of -0.9, 1.3, -0.7, -1.6, -1.4 is -0.7">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Christof’s AI-related notes</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">NanoGPT - Math Trick</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Environment</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./install-env.html" class="sidebar-item-text sidebar-link">Install Environment</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./jupyter.html" class="sidebar-item-text sidebar-link">Using Jupiter Notebooks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tmux.html" class="sidebar-item-text sidebar-link">Using tmux</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Foundations</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">Loss Functions</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cross-entropy-loss.html" class="sidebar-item-text sidebar-link">Cross-Entropy Loss</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">Optimization</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization.html" class="sidebar-item-text sidebar-link">Optimization</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">Practical</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./architectures.html" class="sidebar-item-text sidebar-link">Architectures</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">Samples</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./titanic - linear and nn from scratch.html" class="sidebar-item-text sidebar-link">Titanic</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./traffic-sign-recognition.html" class="sidebar-item-text sidebar-link">Traffic Sign Recognition</a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">Large Language Models</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false">General</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./llm.html" class="sidebar-item-text sidebar-link">Large Language Models</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="false">Building Blocks</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./self-attention.html" class="sidebar-item-text sidebar-link">Self Attention</a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">NanoGPT experiment</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nanogpt-pytorch-embeddings.html" class="sidebar-item-text sidebar-link">NanoGPT - Embeddings</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nanogpt-math-trick.html" class="sidebar-item-text sidebar-link active">NanoGPT - Math Trick</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nanogpt-bigram-model.html" class="sidebar-item-text sidebar-link">NanoGPT - Bigram Model</a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="true">Pytorch</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pytorch-broadcasting.html" class="sidebar-item-text sidebar-link">Pytorch Broadcasting</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#building-manual-intuition-averaging-prior-token-features" id="toc-building-manual-intuition-averaging-prior-token-features" class="nav-link active" data-scroll-target="#building-manual-intuition-averaging-prior-token-features">Building manual intuition: averaging prior token features</a></li>
  <li><a href="#making-this-efficient" id="toc-making-this-efficient" class="nav-link" data-scroll-target="#making-this-efficient">Making this efficient</a></li>
  <li><a href="#applying-the-matrix-technique-on-our-training-data" id="toc-applying-the-matrix-technique-on-our-training-data" class="nav-link" data-scroll-target="#applying-the-matrix-technique-on-our-training-data">Applying the matrix technique on our training data</a></li>
  <li><a href="#doing-the-same-with-softmax" id="toc-doing-the-same-with-softmax" class="nav-link" data-scroll-target="#doing-the-same-with-softmax">Doing the same with SoftMax</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/xstof/xstofai/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">NanoGPT - Math Trick</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="building-manual-intuition-averaging-prior-token-features" class="level2">
<h2 class="anchored" data-anchor-id="building-manual-intuition-averaging-prior-token-features">Building manual intuition: averaging prior token features</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np <span class="co"># linear algebra</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd <span class="co"># data processing, CSV file I/O (e.g. pd.read_csv)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.nn <span class="im">import</span> functional <span class="im">as</span> F</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>torch.set_printoptions(precision<span class="op">=</span><span class="dv">1</span>, sci_mode<span class="op">=</span><span class="va">False</span>, profile<span class="op">=</span><span class="st">'short'</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>generator <span class="op">=</span> torch.manual_seed(<span class="dv">42</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>context_length <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>vocab_size <span class="op">=</span> <span class="dv">8</span> <span class="co"># 8 characters or language tokens possible</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>B,T,C <span class="op">=</span> (batch_size, context_length, vocab_size)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>B,T,C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(4, 6, 8)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># x is our training data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.randn(batch_size,context_length, vocab_size)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.48,  1.35, -0.16, -0.42,  0.94, -0.18,  1.06,  0.21],
         [ 1.31,  0.46,  0.26, -0.76, -2.05, -1.53,  0.40,  0.63],
         [-0.15, -2.32,  1.30,  0.49,  1.13, -0.36,  0.36,  2.00],
         [ 1.04,  1.69,  0.02, -0.83, -1.08, -0.78,  0.51,  0.08],
         [ 0.40,  1.99, -0.46, -0.06, -1.37,  0.33, -0.98,  0.30],
         [ 0.19,  0.41, -1.58,  2.25,  1.00,  1.36,  0.63,  0.41]],

        [[-0.35,  1.46,  0.17,  1.05,  0.01, -0.08,  0.64,  0.57],
         [ 0.51,  0.22, -0.91,  1.48, -0.91, -0.53, -0.81,  0.52],
         [-0.13,  0.78,  0.56,  1.86,  1.04, -0.86,  0.84, -0.32],
         [-1.98,  0.02, -1.41, -1.88, -0.18,  0.79,  0.52, -0.27],
         [ 1.71,  0.06,  0.86, -0.59, -1.03, -0.22,  0.80,  0.91],
         [ 0.27, -0.04, -0.48,  0.32,  0.39,  0.73,  0.25,  0.08]],

        [[-0.71, -0.05,  0.52,  0.97, -0.28, -0.61, -0.56, -0.97],
         [ 1.34,  0.71,  0.35, -0.54,  0.86, -0.67,  1.07, -0.25],
         [-2.31, -1.29,  0.21, -1.24,  1.86,  0.06,  0.77,  2.56],
         [ 1.20, -0.98,  0.30,  0.93, -1.97, -1.41,  1.74,  1.84],
         [-0.00,  0.08, -0.46, -0.06, -0.22, -1.25, -0.49, -0.34],
         [-0.59,  0.08,  0.19, -0.97,  1.89,  0.44,  0.14,  0.31]],

        [[-0.49,  0.05,  0.33,  0.13,  2.85, -0.74,  0.20, -1.34],
         [-0.57, -0.33, -0.31, -0.72,  0.08, -0.21, -0.57,  0.40],
         [-0.55,  1.99,  0.85, -0.70,  0.31,  0.29,  0.41, -1.26],
         [-0.39,  1.89,  0.18, -0.04, -0.09, -1.18,  1.55,  0.54],
         [-0.20,  0.69, -1.34,  1.65,  1.98, -0.10,  0.49, -0.44],
         [-0.49, -0.36, -0.06, -0.48,  0.99,  0.27, -1.83,  0.36]]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for the 2nd item in our batch (index 1), the features of token 5 (index 4) are:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>,<span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([ 0.0, -0.3, -1.3, -0.6,  0.5,  0.5,  1.1,  0.1])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if instead we want all the features of all the tokens before token 5 (index 4):</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>, :<span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[-0.9, -0.7,  0.1,  0.5, -0.5,  1.2, -0.8, -0.7],
        [-1.4,  0.0, -0.1,  0.7, -0.1,  1.8, -1.2,  1.4],
        [ 1.4,  0.9,  2.2,  0.5,  0.3, -0.2, -1.1,  1.3],
        [-0.2,  0.5,  0.1,  0.4,  0.6, -0.6, -2.2, -0.8]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># and if we want to include the features for token 5 itself:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span>,:<span class="dv">4</span><span class="op">+</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[-0.9, -0.7,  0.1,  0.5, -0.5,  1.2, -0.8, -0.7],
        [-1.4,  0.0, -0.1,  0.7, -0.1,  1.8, -1.2,  1.4],
        [ 1.4,  0.9,  2.2,  0.5,  0.3, -0.2, -1.1,  1.3],
        [-0.2,  0.5,  0.1,  0.4,  0.6, -0.6, -2.2, -0.8],
        [ 0.0, -0.3, -1.3, -0.6,  0.5,  0.5,  1.1,  0.1]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if we want to calculate the mean:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>torch.mean(x[<span class="dv">1</span>, :<span class="dv">4</span><span class="op">+</span><span class="dv">1</span>],<span class="dv">0</span>) <span class="co"># 0 here means: take means across the columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-0.2,  0.1,  0.2,  0.3,  0.2,  0.5, -0.8,  0.2])</code></pre>
</div>
</div>
<p>Note how the mean of <code>-0.9, 1.3, -0.7, -1.6, -1.4</code> is <code>-0.7</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">-</span><span class="fl">0.9</span><span class="op">+</span><span class="fl">1.3</span><span class="op">-</span><span class="fl">0.7</span><span class="op">-</span><span class="fl">1.6</span><span class="op">-</span><span class="fl">1.4</span>)<span class="op">/</span><span class="dv">5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>-0.6599999999999999</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>x_bag_of_words <span class="op">=</span> torch.zeros((B,T,C))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>x_bag_of_words</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.]],

        [[0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.]],

        [[0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.]],

        [[0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.],
         [0., 0., 0., 0., 0., 0., 0., 0.]]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,batch_size):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,context_length):</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        xprev_and_self <span class="op">=</span> x[b,:t<span class="op">+</span><span class="dv">1</span>] <span class="co"># (t+1,vocab_size)</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        x_bag_of_words[b,t] <span class="op">=</span> torch.mean(xprev_and_self, <span class="dv">0</span>) <span class="co"># (1, vocab_size)</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>x_bag_of_words</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 1.9,  1.5,  0.9, -2.1,  0.7, -1.2, -0.0, -1.6],
         [ 0.6,  1.6,  0.3, -1.8, -0.0, -0.9, -0.4, -0.4],
         [ 0.9,  1.0,  0.0, -1.0, -0.3, -0.2, -0.0,  0.3],
         [ 1.0,  1.1,  0.2, -0.4, -0.3, -0.2, -0.1,  0.4],
         [ 0.5,  0.7,  0.1, -0.0, -0.1, -0.2,  0.0,  0.2],
         [ 0.2,  0.7, -0.1, -0.1, -0.3,  0.2, -0.2,  0.1]],

        [[-0.9, -0.7,  0.1,  0.5, -0.5,  1.2, -0.8, -0.7],
         [-1.2, -0.3,  0.0,  0.6, -0.3,  1.5, -1.0,  0.3],
         [-0.3,  0.1,  0.7,  0.6, -0.1,  0.9, -1.0,  0.6],
         [-0.3,  0.2,  0.6,  0.5,  0.1,  0.5, -1.3,  0.3],
         [-0.2,  0.1,  0.2,  0.3,  0.2,  0.5, -0.8,  0.2],
         [-0.0, -0.0, -0.0,  0.4, -0.1,  0.3, -0.5,  0.3]],

        [[-2.5,  0.5,  0.8,  0.0,  0.6,  0.6,  1.1, -0.5],
         [-1.3,  0.6,  0.6,  0.1,  0.5,  0.9,  0.5, -0.4],
         [-1.4,  0.4,  0.2,  0.2,  0.5,  0.6,  0.2, -0.1],
         [-1.0,  0.3,  0.2,  0.4,  0.7,  0.6,  0.3,  0.0],
         [-0.4,  0.5, -0.1,  0.1,  0.5,  0.8,  0.4,  0.2],
         [-0.2,  0.4, -0.4,  0.2,  0.4,  0.8,  0.2,  0.2]],

        [[-1.0,  1.0,  1.6,  1.5,  0.3, -0.2, -0.7,  0.1],
         [-0.3,  1.0,  0.6,  1.5, -1.1, -0.3, -1.0,  0.5],
         [-0.8,  0.7,  0.4,  0.9, -0.6, -0.5, -0.6, -0.1],
         [-1.0,  0.9,  0.6,  0.7, -0.9, -0.2, -0.2,  0.5],
         [-0.8,  0.7,  0.3,  0.5, -0.9, -0.4, -0.4,  0.3],
         [-0.8,  0.4, -0.0,  0.4, -0.6, -0.5, -0.2,  0.3]]])</code></pre>
</div>
</div>
<p>Note how we calculated before that for:</p>
<ul>
<li>batch item 2 (index 1)</li>
<li>token 5 (index 4)</li>
</ul>
<p>The bag of words was: <code>[-0.7,  0.1, -0.6, -0.1, -0.1,  0.1, -0.0,  0.5]</code></p>
<p>Each of these represent the mean of token 5 and all tokens that came before it, for each channel/features.</p>
</section>
<section id="making-this-efficient" class="level2">
<h2 class="anchored" data-anchor-id="making-this-efficient">Making this efficient</h2>
<p>What we just did was incredibly inefficient and can be optimized through matrix multiplication. Let’s start by creating some test matrices to play with:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> torch.ones(<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> torch.randint(<span class="dv">0</span>,<span class="dv">4</span>,(<span class="dv">3</span>,<span class="dv">2</span>)).<span class="bu">float</span>() <span class="co"># need to convert to float for matrix multiplication</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> a <span class="op">@</span> b <span class="co"># matrix multiplication</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>a,b,c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[1., 1., 1.],
         [1., 1., 1.],
         [1., 1., 1.]]),
 tensor([[0., 2.],
         [2., 1.],
         [1., 3.]]),
 tensor([[3., 6.],
         [3., 6.],
         [3., 6.]]))</code></pre>
</div>
</div>
<p>Note how in the first row of matrix c, the <code>7 8</code> is the sum of columns <code>2 3 2</code> and <code>2 3 3</code> because of how matrix multiplying works. The other rows are exactly the same values (<code>7 8</code>) because matrix a has <code>1</code> in every row.</p>
<p>Let’s introduce the <code>torch.tril()</code> function now, which gives us back the lower triangle of a matrix, zero-ing out the upper part:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> torch.tril(a)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[1., 0., 0.],
        [1., 1., 0.],
        [1., 1., 1.]])</code></pre>
</div>
</div>
<p>Let’s multiply this by our matrix b:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> a <span class="op">@</span> b</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>a,b,c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[1., 0., 0.],
         [1., 1., 0.],
         [1., 1., 1.]]),
 tensor([[0., 2.],
         [2., 1.],
         [1., 3.]]),
 tensor([[0., 2.],
         [2., 3.],
         [3., 6.]]))</code></pre>
</div>
</div>
<p>The first row of a is multiplied by both the columns of b to get to the first row of b: <code>(1*2 + 0*3 + 0*2)=2   (1*2 + 0*3 + 0*3)=2</code> <br> The second row of a is multiplied by both the columns of b to get to the second row of b: <code>(1*2 + 1*3 + 0*2)=5   (1*2 + 1*3 + 0*3)=5</code> <br> The third row of a is multiplied by both the columns of b to get to the third row of b: <code>(1*2 + 1*3 + 1*2)=7   (1*2 + 1*3 + 1*3)=8</code></p>
<p>Note how:</p>
<ul>
<li>the first row in the resulting matrix c has the original values of row 1 of b,</li>
<li>the second row has the sum of the values of row 1 and 2 of b and</li>
<li>the third row has the sum of the values of row 1, 2 and 3 of b</li>
</ul>
<p>We don’t want to sum however. We want to try and get to a mean of a value and all values that came before it. To get the mean, we need to divide the sum by the number of items. For that reason, we won’t use all <code>1</code>s to multiply with:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>a1 <span class="op">=</span> torch.ones(<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>a2 <span class="op">=</span> torch.tril(a1)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>a2_sum <span class="op">=</span> torch.<span class="bu">sum</span>(a2, <span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>) <span class="co"># keepdim is required given that we need the broadcasting to work</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>a3 <span class="op">=</span> a2 <span class="op">/</span> a2_sum</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>a1, a2, a2_sum, a3, b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[1., 1., 1.],
         [1., 1., 1.],
         [1., 1., 1.]]),
 tensor([[1., 0., 0.],
         [1., 1., 0.],
         [1., 1., 1.]]),
 tensor([[1.],
         [2.],
         [3.]]),
 tensor([[1.0, 0.0, 0.0],
         [0.5, 0.5, 0.0],
         [0.3, 0.3, 0.3]]),
 tensor([[0., 2.],
         [2., 1.],
         [1., 3.]]))</code></pre>
</div>
</div>
<p>If we now want the averages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> a3 <span class="op">@</span> b</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.0, 2.0],
        [1.0, 1.5],
        [1.0, 2.0]])</code></pre>
</div>
</div>
<p>(see <a href="https://youtu.be/kCc8FmEb1nY?t=3082">Let’s build GPT: from scratch, in code, spelled out.</a> )</p>
</section>
<section id="applying-the-matrix-technique-on-our-training-data" class="level2">
<h2 class="anchored" data-anchor-id="applying-the-matrix-technique-on-our-training-data">Applying the matrix technique on our training data</h2>
<p>Our training data <code>x</code> looked like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>x <span class="co"># shape: (batch_size x context_length x vocab_size) == (B x T x C)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.48,  1.35, -0.16, -0.42,  0.94, -0.18,  1.06,  0.21],
         [ 1.31,  0.46,  0.26, -0.76, -2.05, -1.53,  0.40,  0.63],
         [-0.15, -2.32,  1.30,  0.49,  1.13, -0.36,  0.36,  2.00],
         [ 1.04,  1.69,  0.02, -0.83, -1.08, -0.78,  0.51,  0.08],
         [ 0.40,  1.99, -0.46, -0.06, -1.37,  0.33, -0.98,  0.30],
         [ 0.19,  0.41, -1.58,  2.25,  1.00,  1.36,  0.63,  0.41]],

        [[-0.35,  1.46,  0.17,  1.05,  0.01, -0.08,  0.64,  0.57],
         [ 0.51,  0.22, -0.91,  1.48, -0.91, -0.53, -0.81,  0.52],
         [-0.13,  0.78,  0.56,  1.86,  1.04, -0.86,  0.84, -0.32],
         [-1.98,  0.02, -1.41, -1.88, -0.18,  0.79,  0.52, -0.27],
         [ 1.71,  0.06,  0.86, -0.59, -1.03, -0.22,  0.80,  0.91],
         [ 0.27, -0.04, -0.48,  0.32,  0.39,  0.73,  0.25,  0.08]],

        [[-0.71, -0.05,  0.52,  0.97, -0.28, -0.61, -0.56, -0.97],
         [ 1.34,  0.71,  0.35, -0.54,  0.86, -0.67,  1.07, -0.25],
         [-2.31, -1.29,  0.21, -1.24,  1.86,  0.06,  0.77,  2.56],
         [ 1.20, -0.98,  0.30,  0.93, -1.97, -1.41,  1.74,  1.84],
         [-0.00,  0.08, -0.46, -0.06, -0.22, -1.25, -0.49, -0.34],
         [-0.59,  0.08,  0.19, -0.97,  1.89,  0.44,  0.14,  0.31]],

        [[-0.49,  0.05,  0.33,  0.13,  2.85, -0.74,  0.20, -1.34],
         [-0.57, -0.33, -0.31, -0.72,  0.08, -0.21, -0.57,  0.40],
         [-0.55,  1.99,  0.85, -0.70,  0.31,  0.29,  0.41, -1.26],
         [-0.39,  1.89,  0.18, -0.04, -0.09, -1.18,  1.55,  0.54],
         [-0.20,  0.69, -1.34,  1.65,  1.98, -0.10,  0.49, -0.44],
         [-0.49, -0.36, -0.06, -0.48,  0.99,  0.27, -1.83,  0.36]]])</code></pre>
</div>
</div>
<p>It has 3 dimensions: batch, time/context, features. Let’s try to treat this matrix so that every value is the mean of all prior values <em>in the same batch item</em>. So for example, the 3rd token (index 2) on the 2nd item in our batch (index 1) has features: <br> <code>[-0.1,  0.8,  0.6,  1.9,  1.0, -0.9,  0.8, -0.3]</code></p>
<p>We want these features to be the averages of the features of itself and all the features of the prior tokens:</p>
<ul>
<li><code>[-0.4,  1.5,  0.2,  1.1,  0.0, -0.1,  0.6,  0.6]</code></li>
<li><code>[ 0.5,  0.2, -0.9,  1.5, -0.9, -0.5, -0.8,  0.5]</code></li>
</ul>
<p>Let’s start by applying a triangular vector (shape ) to each batch item:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tril <span class="op">=</span> torch.tril(torch.ones(T,T))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>tril, tril.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[1., 0., 0., 0., 0., 0.],
         [1., 1., 0., 0., 0., 0.],
         [1., 1., 1., 0., 0., 0.],
         [1., 1., 1., 1., 0., 0.],
         [1., 1., 1., 1., 1., 0.],
         [1., 1., 1., 1., 1., 1.]]),
 torch.Size([6, 6]))</code></pre>
</div>
</div>
<p>Let’s apply this to our entire training data set; using broadcasting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>tril <span class="op">@</span> x <span class="co"># element-wise (T,T) @ (BxTxC) == (BxTxT) @ (BxTxC) == (BxTxC)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 1.9,  1.5,  0.9, -2.1,  0.7, -1.2, -0.0, -1.6],
         [ 1.2,  3.1,  0.5, -3.5, -0.0, -1.8, -0.8, -0.8],
         [ 2.8,  3.0,  0.0, -3.1, -0.8, -0.7, -0.0,  0.8],
         [ 4.1,  4.3,  0.6, -1.7, -1.0, -0.7, -0.3,  1.7],
         [ 2.7,  3.4,  0.4, -0.0, -0.7, -1.1,  0.0,  0.9],
         [ 1.2,  4.4, -0.5, -0.6, -2.0,  1.0, -1.2,  0.4]],

        [[-0.9, -0.7,  0.1,  0.5, -0.5,  1.2, -0.8, -0.7],
         [-2.3, -0.6,  0.0,  1.2, -0.6,  3.0, -2.0,  0.6],
         [-0.9,  0.2,  2.2,  1.7, -0.2,  2.8, -3.1,  1.9],
         [-1.0,  0.8,  2.3,  2.2,  0.3,  2.2, -5.3,  1.2],
         [-1.0,  0.4,  0.9,  1.6,  0.9,  2.7, -4.1,  1.2],
         [-0.3, -0.1, -0.1,  2.2, -0.9,  1.9, -2.8,  1.7]],

        [[-2.5,  0.5,  0.8,  0.0,  0.6,  0.6,  1.1, -0.5],
         [-2.7,  1.2,  1.2,  0.2,  0.9,  1.9,  1.1, -0.8],
         [-4.2,  1.1,  0.6,  0.7,  1.6,  1.9,  0.7, -0.2],
         [-4.2,  1.4,  0.7,  1.4,  2.7,  2.3,  1.4,  0.2],
         [-2.2,  2.4, -0.7,  0.3,  2.6,  3.9,  2.1,  0.8],
         [-1.1,  2.4, -2.5,  1.2,  2.2,  5.0,  1.4,  1.4]],

        [[-1.0,  1.0,  1.6,  1.5,  0.3, -0.2, -0.7,  0.1],
         [-0.6,  1.9,  1.2,  3.1, -2.2, -0.6, -1.9,  0.9],
         [-2.5,  2.2,  1.2,  2.7, -1.9, -1.4, -1.8, -0.2],
         [-4.1,  3.5,  2.5,  2.8, -3.5, -0.6, -1.0,  1.8],
         [-4.1,  3.6,  1.7,  2.6, -4.4, -2.2, -2.1,  1.3],
         [-4.6,  2.1, -0.3,  2.7, -3.4, -2.7, -1.4,  2.0]]])</code></pre>
</div>
</div>
<p>This is similar to our previous example on how to incrementally add numbers, but now with an additional broadcasted batch dimension. We’ll want not to add those numbers those, but to average them out as before:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> tril <span class="op">/</span> torch.<span class="bu">sum</span>(tril, <span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>) <span class="co"># keepdim for broadcasting</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>weights</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
        [0.5, 0.5, 0.0, 0.0, 0.0, 0.0],
        [0.3, 0.3, 0.3, 0.0, 0.0, 0.0],
        [0.2, 0.2, 0.2, 0.2, 0.0, 0.0],
        [0.2, 0.2, 0.2, 0.2, 0.2, 0.0],
        [0.2, 0.2, 0.2, 0.2, 0.2, 0.2]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>x_bag_of_words_with_matrix <span class="op">=</span> weights <span class="op">@</span> x</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">0</span>], x_bag_of_words_with_matrix[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[ 1.9,  1.5,  0.9, -2.1,  0.7, -1.2, -0.0, -1.6],
         [-0.8,  1.6, -0.4, -1.4, -0.7, -0.6, -0.8,  0.8],
         [ 1.6, -0.2, -0.5,  0.4, -0.8,  1.1,  0.8,  1.7],
         [ 1.3,  1.3,  0.6,  1.3, -0.2,  0.0, -0.3,  0.9],
         [-1.4, -0.9, -0.2,  1.7,  0.3, -0.4,  0.3, -0.8],
         [-1.6,  1.0, -0.9, -0.6, -1.3,  2.1, -1.2, -0.5]]),
 tensor([[ 1.9,  1.5,  0.9, -2.1,  0.7, -1.2, -0.0, -1.6],
         [ 0.6,  1.6,  0.3, -1.8, -0.0, -0.9, -0.4, -0.4],
         [ 0.9,  1.0,  0.0, -1.0, -0.3, -0.2, -0.0,  0.3],
         [ 1.0,  1.1,  0.2, -0.4, -0.3, -0.2, -0.1,  0.4],
         [ 0.5,  0.7,  0.1, -0.0, -0.1, -0.2,  0.0,  0.2],
         [ 0.2,  0.7, -0.1, -0.1, -0.3,  0.2, -0.2,  0.1]]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>x_bag_of_words.allclose(x_bag_of_words_with_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>torch.set_printoptions(precision<span class="op">=</span><span class="dv">2</span>, sci_mode<span class="op">=</span><span class="va">False</span>, profile<span class="op">=</span><span class="st">'short'</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x[<span class="dv">0</span>])</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'==='</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x_bag_of_words_with_matrix[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([[ 1.93,  1.49,  0.90, -2.11,  0.68, -1.23, -0.04, -1.60],
        [-0.75,  1.65, -0.39, -1.40, -0.73, -0.56, -0.77,  0.76],
        [ 1.64, -0.16, -0.50,  0.44, -0.76,  1.08,  0.80,  1.68],
        [ 1.28,  1.30,  0.61,  1.33, -0.23,  0.04, -0.25,  0.86],
        [-1.38, -0.87, -0.22,  1.72,  0.32, -0.42,  0.31, -0.77],
        [-1.56,  1.00, -0.88, -0.60, -1.27,  2.12, -1.23, -0.49]])
===
tensor([[ 1.93,  1.49,  0.90, -2.11,  0.68, -1.23, -0.04, -1.60],
        [ 0.59,  1.57,  0.25, -1.75, -0.02, -0.90, -0.41, -0.42],
        [ 0.94,  0.99,  0.00, -1.02, -0.27, -0.24, -0.00,  0.28],
        [ 1.02,  1.07,  0.16, -0.43, -0.26, -0.17, -0.07,  0.42],
        [ 0.54,  0.68,  0.08, -0.00, -0.14, -0.22,  0.01,  0.18],
        [ 0.19,  0.73, -0.08, -0.10, -0.33,  0.17, -0.20,  0.07]])</code></pre>
</div>
</div>
</section>
<section id="doing-the-same-with-softmax" class="level2">
<h2 class="anchored" data-anchor-id="doing-the-same-with-softmax">Doing the same with SoftMax</h2>
<p>This was our tril matrix, which we got by <code>tril = torch.tril(torch.ones(T,T))</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>tril</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[1., 0., 0., 0., 0., 0.],
        [1., 1., 0., 0., 0., 0.],
        [1., 1., 1., 0., 0., 0.],
        [1., 1., 1., 1., 0., 0.],
        [1., 1., 1., 1., 1., 0.],
        [1., 1., 1., 1., 1., 1.]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> torch.zeros(T,T)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>weights</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<p>We can mask the weights and and apply a number (here minus infinity) to the non-masked values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> weights.masked_fill(tril <span class="op">==</span> <span class="dv">0</span>, <span class="bu">float</span>(<span class="st">'-inf'</span>)) <span class="co"># =&gt; this is essentially saying: the future cannot communicate with the past</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>weights</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0., -inf, -inf, -inf, -inf, -inf],
        [0., 0., -inf, -inf, -inf, -inf],
        [0., 0., 0., -inf, -inf, -inf],
        [0., 0., 0., 0., -inf, -inf],
        [0., 0., 0., 0., 0., -inf],
        [0., 0., 0., 0., 0., 0.]])</code></pre>
</div>
</div>
<p>The above matrix is essentially making sure that for:</p>
<ul>
<li>the first token (which is line 1), it only has itself to refer to: <code>[0., -inf, -inf, -inf, -inf, -inf]</code></li>
<li>token 2 (which is line 2), has itself and token 1 to refer to: <code>[0., 0., -inf, -inf, -inf, -inf]</code></li>
<li>token 3 (which is line 3), has token 1, 2 and itself to refer to: <code>[0., 0., 0., -inf, -inf, -inf]</code></li>
</ul>
<p>and so on…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> weights.softmax(<span class="dv">1</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>weights</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[1.00, 0.00, 0.00, 0.00, 0.00, 0.00],
        [0.50, 0.50, 0.00, 0.00, 0.00, 0.00],
        [0.33, 0.33, 0.33, 0.00, 0.00, 0.00],
        [0.25, 0.25, 0.25, 0.25, 0.00, 0.00],
        [0.20, 0.20, 0.20, 0.20, 0.20, 0.00],
        [0.17, 0.17, 0.17, 0.17, 0.17, 0.17]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>x_bag_of_words_using_softmax <span class="op">=</span> weights <span class="op">@</span> x</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>torch.allclose(x_bag_of_words_using_softmax, x_bag_of_words)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<p>(For more explanation, see <a href="https://youtu.be/kCc8FmEb1nY?t=3355">Let’s build GPT: from scratch, in code, spelled out.</a>)</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>What we’ve done here is to do a weighted average of elements and their past using matrix multiplication. In our case here, all weights were equal, but you can see that this does not have to be the case necesarily. The elements in the lower part of the triangular weights matrix determine how much of each element in the past the weighted average is build of.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>